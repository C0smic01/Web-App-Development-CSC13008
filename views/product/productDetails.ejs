<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Product Details</title>
    </head>
    <body>
        <section id="prodetails" class="section-p1">
            <% if(product){ %>
                <div class="w-[40%]">
                    <!-- Main product image container with fixed dimensions -->
                    <div class="w-full h-[500px] mb-4 overflow-hidden rounded-lg">
                        <img 
                            src="<%= product.img %>" 
                            alt="<%= product.product_name %>" 
                            id="mainImg"
                            class="w-full h-full object-contain rounded-lg "
                        >
                    </div>
                    
                    <!-- Thumbnail images container -->
                    <% if (product.additional_images && product.additional_images.length > 0) { %>
                        <div class="flex gap-2 overflow-x-auto ">
                            <!-- Main image thumbnail with fixed dimensions -->
                            <div class="w-24 h-24 flex-shrink-0 overflow-hidden rounded-lg">
                                <img 
                                    src="<%= product.img %>" 
                                    alt="Main thumbnail"
                                    class="w-full h-full object-cover cursor-pointer hover:opacity-80 transition-opacity border-2 small-img"
                                    onclick="changeMainImage(this.src)"
                                >
                            </div>
                            
                            <!-- Additional images thumbnails -->
                            <% product.additional_images.forEach(function(image) { %>
                                <div class="w-24 h-24 flex-shrink-0 overflow-hidden rounded-lg">
                                    <img 
                                        src="<%= image.image_path %>" 
                                        alt="Additional thumbnail"
                                        class="w-full h-full object-cover cursor-pointer hover:opacity-80 transition-opacity small-img"
                                        onclick="changeMainImage(this.src)"
                                    >
                                </div>
                            <% }); %>
                        </div>
                    <% } %>
                </div>
                <div class="w-[50%] pt-[30px]">
                    <h5 class="text-sm font-semibold">Home >
                        <% if(product.categories && product.categories.length > 0) { %>
                            <% product.categories.map((category, index) => { %>
                                <%= category.category_name %><%= index < product.categories.length - 1 ? ' / ' : '' %>
                            <% }) %>
                        <% } else { %>
                            Unknown Category
                        <% } %>
                    </h5>
                    <h4
                    class="pt-[40px] font-bold text-2xl"
                    ><%= product.product_name  %></h4>
                    <h4 
                        style="color: #088178;"
                        class="text-xl font-bold pt-[40px] "><%= product.price%>
                        <span class="text-lg font-normal">
                            vnd
                        </span>
                    </h4>                    
                    <select 
                    style="border: 1px solid #088178; "
                    class="block px-[10px] py-[5px] my-[10px] rounded-[5px] outline-none text-sm "
                    >
                        <option>Select Size</option>
                        <option>XL</option>
                        <option>Medium</option>
                        <option>Small</option>
                        <option>Large</option>
                    </select>
                   <div
                   class="h-[50px]"
                   >
                        <input 
                        style="border: 1px solid #088178; "
                        class="outline-none text-center rounded-[4px] p-[4px] mr-[10px] text-base pl-[10px] w-[50px] h-full"
                        type="number" value="1" min="0" max="<%= product.remaining %>">
                        <button 
                        style="background-color: #088178"
                        class="add-to-cart-btn rounded-md text-center text-sm font-semibold px-[16px] text-white p-[8px] h-full">Add to cart</button>
                        <span class="remaining">Remaining: <%= product.remaining %></span>
                   </div>
                    <h4 class="text-2xl font-bold pt-[40px] py-[20px]">Product Details</h4>
                    <span class="text-sm"><%= product.description %></span>
                </div>
            <% } %>   
        </section>

        <section>   
            <div class="text-center mb-8 mt-12">
                <h2 class="text-2xl font-bold mb-2">Customer Reviews</h2>
                <div class="flex items-center justify-center gap-2">
                    <div class="flex items-center">
                        <!-- Full stars -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        <!-- Repeat for all full stars -->
                        <div class="relative">
                            <!-- Half star background -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <!-- Half star overlay -->
                            <div class="absolute inset-0 overflow-hidden w-[50%]">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <span class="text-lg font-semibold"><%= reviews.avg_rating %> out of 5</span>
                </div>
                <p class="text-gray-600 mt-1">Based on <%= reviews.total_review%> reviews</p>
            </div>
            
            <div id="add-review-section">
                <%- include('../review/reviewForm',{product: product.product_id})%>
            </div>
            
            <div id="review-section">
                <%- include('../review/reviewList',{reviews: reviews.reviews, currentPage: reviews.currentPage, totalPage: reviews.totalPage, product:product.product_id})%>
            </div>
        </section>

        <section>
            <h2 class="text-2xl font-bold mb-2 text-center w-full mt-16 py-[20px] ">You May Also Like</h2>
            <div class="flex w-full justify-between px-[80px] ">
                <%- include('productList',{products:relatedProducts})%>
            </div>
        </section>

        <script type="module">
            import Cart from '/cart/models/Cart.js'
            const cart = new Cart();

            function showNotification(message) {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.classList.add('cart-notification');

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 2000);
            }
            
            document.querySelector(".add-to-cart-btn").addEventListener("click", function () {
                const productId = "<%= product.product_id %>"
                const name = "<%= product.product_name %>"
                const price = parseFloat("<%= product.price %>")
                const image = "<%= product.img %>"; 
                const quantity = parseInt(document.querySelector("input[type='number']").value); 

                if (quantity <= 0) {
                    alert("Please select a valid quantity.");
                    return;
                }
                
                cart.addItem({
                    productId: productId,
                    name: name,
                    price: price,
                    quantity: quantity,
                    image: image
                });

                showNotification(`${quantity}x ${name} added to cart`);
            });
        </script>
        
        <script>
            function changeMainImage(src) {
                document.getElementById('mainImg').src = src;
            }

            // Add highlight for selected thumbnail
            document.addEventListener('DOMContentLoaded', function() {
                const smallImages = document.querySelectorAll('.small-img');
                smallImages.forEach(img => {
                    img.addEventListener('click', function() {
                        // Remove border from all thumbnails
                        smallImages.forEach(i => i.classList.remove('border-violet-600', 'border-2'));
                        // Add border to clicked thumbnail
                        this.classList.add('border-violet-600', 'border-2');
                    });
                });

                // Highlight the first thumbnail by default
                if (smallImages.length > 0) {
                    smallImages[0].classList.add('border-violet-600', 'border-2');
                }
            });
        </script>
    </body>
</html>